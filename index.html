<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #e4e4e7;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            margin-bottom: 50px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fafafa;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .current-time {
            font-size: 1rem;
            color: #a1a1aa;
            font-weight: 400;
        }

        .update-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #27272a;
            color: #a1a1aa;
            padding: 10px 18px;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .update-btn:hover {
            background: #3a3a3a;
            color: #fafafa;
        }

        .update-btn input {
            display: none;
        }

        .next-class-card {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 1px solid #3a3a3a;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .next-class-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .next-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #71717a;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .next-class-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #fafafa;
            margin-bottom: 20px;
        }

        .next-class-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: #27272a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a1a1aa;
        }

        .detail-content h4 {
            font-size: 0.75rem;
            color: #71717a;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-content p {
            font-size: 1rem;
            color: #fafafa;
            font-weight: 500;
        }

        .countdown {
            display: inline-block;
            background: #27272a;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #3b82f6;
            font-weight: 600;
            margin-top: 15px;
        }

        .timeline-section {
            margin-bottom: 50px;
        }

        .day-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fafafa;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-date {
            font-size: 0.9rem;
            color: #71717a;
            font-weight: 400;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #27272a;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: #1a1a1a;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            border-color: #3a3a3a;
            transform: translateX(5px);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -32px;
            top: 24px;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            border: 3px solid #0a0a0a;
        }

        .timeline-item.completed::before {
            background: #22c55e;
        }

        .timeline-item.ongoing::before {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .class-time {
            font-size: 0.85rem;
            color: #a1a1aa;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .class-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: #fafafa;
            margin-bottom: 12px;
        }

        .class-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #a1a1aa;
        }

        .meta-item i {
            color: #71717a;
            font-size: 0.9rem;
        }

        .join-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .join-button:hover {
            background: #2563eb;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #71717a;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .no-classes {
            text-align: center;
            padding: 60px 20px;
            color: #71717a;
        }

        .info-box {
            background: #1a2a1a;
            border: 1px solid #2a4a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            color: #86efac;
        }

        .info-box h3 {
            color: #dcfce7;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .next-class-title { font-size: 1.4rem; }
            .timeline { padding-left: 30px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Class Schedule</h1>
            <div class="current-time" id="currentTime"></div>
            <label class="update-btn">
                <i class="fas fa-upload"></i>
                <span>Update Schedule</span>
                <input type="file" id="csvFile" accept=".csv">
            </label>
        </header>

        <div id="infoBox"></div>
        <div id="nextClass"></div>
        <div id="schedule"></div>
        <div class="loading" id="loading">
            <i class="fas fa-circle-notch"></i>
            <p>Waiting for schedule file...</p>
            <p style="font-size: 0.85rem; margin-top: 10px;">Click "Update Schedule" to load your CSV file</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        let allClasses = [];

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('en-US', options);
        }

        function parseTime(timeStr) {
            if (!timeStr) return null;
            const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return null;
            let [_, hours, minutes, period] = match;
            hours = parseInt(hours);
            minutes = parseInt(minutes);
            if (period.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (period.toUpperCase() === 'AM' && hours === 12) hours = 0;
            return { hours, minutes };
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[0] - 1, parts[1]);
        }

        function getClassDateTime(cls) {
            const date = parseDate(cls.date);
            if (!date) return null;
            const time = parseTime(cls.time.split(' - ')[0]);
            if (!time) return null;
            date.setHours(time.hours, time.minutes, 0, 0);
            return date;
        }

        function getClassStatus(cls) {
            const now = new Date();
            const startTime = getClassDateTime(cls);
            if (!startTime) return 'upcoming';
            
            const endMatch = cls.time.match(/- (\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!endMatch) return startTime > now ? 'upcoming' : 'completed';
            
            const endTime = new Date(startTime);
            let [_, hours, minutes, period] = endMatch;
            hours = parseInt(hours);
            if (period.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (period.toUpperCase() === 'AM' && hours === 12) hours = 0;
            endTime.setHours(hours, parseInt(minutes), 0, 0);
            
            if (now < startTime) return 'upcoming';
            if (now > endTime) return 'completed';
            return 'ongoing';
        }

        function getCountdown(cls) {
            const now = new Date();
            const startTime = getClassDateTime(cls);
            if (!startTime || startTime < now) return null;
            
            const diff = startTime - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `Starts in ${days}d ${hours}h`;
            if (hours > 0) return `Starts in ${hours}h ${minutes}m`;
            return `Starts in ${minutes}m`;
        }

        function extractMeetLink(joinInfo) {
            const match = joinInfo.match(/meet\.google\.com\/[\w-]+/);
            return match ? `https://${match[0]}` : null;
        }

        function renderNextClass() {
            const upcoming = allClasses
                .filter(cls => getClassStatus(cls) === 'upcoming')
                .sort((a, b) => getClassDateTime(a) - getClassDateTime(b));
            
            if (upcoming.length === 0) {
                document.getElementById('nextClass').innerHTML = '';
                return;
            }

            const next = upcoming[0];
            const countdown = getCountdown(next);
            const meetLink = extractMeetLink(next.joiningInfo);
            
            document.getElementById('nextClass').innerHTML = `
                <div class="next-class-card">
                    <div class="next-label">Next Class</div>
                    <h2 class="next-class-title">${next.topic}</h2>
                    <div class="next-class-details">
                        <div class="detail-item">
                            <div class="detail-icon"><i class="far fa-calendar"></i></div>
                            <div class="detail-content">
                                <h4>Date & Time</h4>
                                <p>${next.day}, ${next.date}<br>${next.time}</p>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="far fa-user"></i></div>
                            <div class="detail-content">
                                <h4>Mentor</h4>
                                <p>${next.mentor}</p>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="far fa-bookmark"></i></div>
                            <div class="detail-content">
                                <h4>Module</h4>
                                <p>${next.module}</p>
                            </div>
                        </div>
                    </div>
                    ${countdown ? `<div class="countdown"><i class="far fa-clock"></i> ${countdown}</div>` : ''}
                    ${meetLink ? `<a href="${meetLink}" class="join-button" target="_blank"><i class="fas fa-video"></i> Join on Google Meet</a>` : ''}
                </div>
            `;
        }

        function renderSchedule() {
            const byDate = {};
            allClasses.forEach(cls => {
                if (!byDate[cls.date]) byDate[cls.date] = [];
                byDate[cls.date].push(cls);
            });

            let html = '';
            Object.keys(byDate).sort((a, b) => parseDate(a) - parseDate(b)).forEach(date => {
                const classes = byDate[date];
                const day = classes[0].day;
                
                html += `
                    <div class="timeline-section">
                        <div class="day-header">
                            ${day}
                            <span class="day-date">${date}</span>
                        </div>
                        <div class="timeline">
                `;
                
                classes.forEach(cls => {
                    const status = getClassStatus(cls);
                    const meetLink = extractMeetLink(cls.joiningInfo);
                    
                    html += `
                        <div class="timeline-item ${status}">
                            <div class="class-time"><i class="far fa-clock"></i> ${cls.time}</div>
                            <div class="class-title">${cls.topic}</div>
                            <div class="class-meta">
                                <div class="meta-item">
                                    <i class="far fa-user"></i>
                                    <span>${cls.mentor}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="far fa-bookmark"></i>
                                    <span>${cls.module}</span>
                                </div>
                                <div class="meta-item">
                                    <i class="far fa-desktop"></i>
                                    <span>${cls.platform}</span>
                                </div>
                            </div>
                            ${meetLink && status !== 'completed' ? `<a href="${meetLink}" class="join-button" target="_blank"><i class="fas fa-video"></i> Join Meeting</a>` : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });

            document.getElementById('schedule').innerHTML = html;
        }

        function processCSVData(results) {
            console.log('Headers found:', results.meta.fields);
            console.log('First 3 rows:', results.data.slice(0, 3));
            console.log('Total rows:', results.data.length);
            
            // Get all possible header variations
            const getField = (row, ...names) => {
                for (let name of names) {
                    const val = row[name];
                    if (val !== undefined && val !== null && val !== '') {
                        return String(val).trim();
                    }
                }
                return '';
            };
            
            // Track last known values for date, day, week (for merged cells)
            let lastWeek = '';
            let lastDate = '';
            let lastDay = '';
            
            allClasses = results.data
                .filter(row => {
                    const topic = getField(row, 'Topic', 'topic', 'TOPIC');
                    return topic; // Only need topic to exist
                })
                .map(row => {
                    // Get current values or use last known (for merged cells)
                    const currentWeek = getField(row, 'Week', 'week', 'WEEK');
                    const currentDate = getField(row, 'Date', 'date', 'DATE');
                    const currentDay = getField(row, 'Day', 'day', 'DAY');
                    
                    if (currentWeek) lastWeek = currentWeek;
                    if (currentDate) lastDate = currentDate;
                    if (currentDay) lastDay = currentDay;
                    
                    const cls = {
                        week: currentWeek || lastWeek,
                        date: currentDate || lastDate,
                        day: currentDay || lastDay,
                        topic: getField(row, 'Topic', 'topic', 'TOPIC'),
                        platform: getField(row, 'Platform', 'platform', 'PLATFORM'),
                        joiningInfo: getField(row, 'Joining Info', 'JoiningInfo', 'joining info', 'JOINING INFO'),
                        time: getField(row, 'Time', 'time', 'TIME'),
                        module: getField(row, 'Module', 'module', 'MODULE'),
                        mentor: getField(row, 'Mentor', 'mentor', 'MENTOR'),
                        recordingStatus: getField(row, 'Recording Status', 'RecordingStatus', 'recording status', 'RECORDING STATUS')
                    };
                    console.log('Mapped class:', cls);
                    return cls;
                })
                .filter(cls => cls.date && cls.topic); // Final filter for valid classes
            
            console.log('Total classes processed:', allClasses.length);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('infoBox').innerHTML = `
                <div class="info-box">
                    <h3><i class="fas fa-check-circle"></i> Schedule Loaded Successfully</h3>
                    <p>Showing ${allClasses.length} classes. Upload a new CSV anytime to update.</p>
                </div>
            `;
            
            if (allClasses.length === 0) {
                document.getElementById('schedule').innerHTML = '<div class="no-classes"><i class="far fa-calendar-times"></i><p>No classes found in CSV</p></div>';
                return;
            }
            
            renderNextClass();
            renderSchedule();
        }

        function loadScheduleFromFile(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                transformHeader: function(header) {
                    return header.trim();
                },
                complete: function(results) {
                    console.log('CSV Parsed:', results);
                    processCSVData(results);
                },
                error: function(error) {
                    document.getElementById('loading').innerHTML = `
                        <div style="color: #fca5a5;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error reading CSV file</p>
                            <p style="font-size: 0.85rem; margin-top: 10px;">${error.message}</p>
                        </div>
                    `;
                }
            });
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadScheduleFromFile(file);
            }
        });

        // Try to auto-load schedule.csv from same folder
        async function autoLoadSchedule() {
            try {
                const response = await fetch('schedule.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: false,
                        transformHeader: function(header) {
                            return header.trim();
                        },
                        complete: function(results) {
                            console.log('Auto-loaded CSV:', results);
                            processCSVData(results);
                        }
                    });
                } else {
                    console.log('No schedule.csv found, waiting for manual upload');
                }
            } catch (error) {
                console.log('Could not auto-load schedule.csv:', error);
            }
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);
        setInterval(() => {
            if (allClasses.length > 0) {
                renderNextClass();
                renderSchedule();
            }
        }, 60000);
        
        autoLoadSchedule();
    </script>
</body>
</html>
